<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>A-Frame â€” Gun with Projectiles</title>

        <!-- A-Frame -->
        <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

        <!-- Supprimer grabbable natif -->
        <script> if (AFRAME.components && AFRAME.components['grabbable']) delete AFRAME.components['grabbable']; </script>

        <!-- aframe-extras (sphere-collider) -->
        <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.2/dist/aframe-extras.min.js"></script>

        <!-- Physics system -->
        <script src="https://cdn.jsdelivr.net/npm/@c-frame/aframe-physics-system@4.2.3/dist/aframe-physics-system.min.js"></script>

        <!-- Super-hands -->
        <script src="https://unpkg.com/super-hands@3.0.5/dist/super-hands.min.js"></script>

        <style>body{margin:0}</style>

        <script>
        /* === Composant tir de projectiles === */
        AFRAME.registerComponent('gun-shoot', {
            schema: {
            speed: { type: 'number', default: 10 },
            offset: { type: 'vec3', default: {x: 0, y: 0, z: -0.5} } // sortie du canon
            },
            init: function () {
            this.el.addEventListener('shoot', () => this.shootProjectile());
            },
            shootProjectile: function () {
            const scene = this.el.sceneEl;
            const projectile = document.createElement('a-sphere');
            projectile.setAttribute('radius', 0.05);
            projectile.setAttribute('color', 'red');
            projectile.setAttribute('shadow', 'cast: true');

            // position du canon
            const gunObj = this.el.object3D;
            const offset = new THREE.Vector3(this.data.offset.x, this.data.offset.y, this.data.offset.z);
            gunObj.localToWorld(offset); // convertir offset en coordonnÃ©es monde
            projectile.setAttribute('position', `${offset.x} ${offset.y} ${offset.z}`);

            // physique
            projectile.setAttribute('dynamic-body', 'mass:0.1; shape:sphere');

            // calculer direction du tir (z nÃ©gatif de lâ€™objet)
            const dir = new THREE.Vector3(0,0,-1);
            dir.applyQuaternion(gunObj.quaternion);
            dir.normalize();

            // attendre que le body existe, puis appliquer vÃ©locitÃ©
            projectile.addEventListener('body-loaded', () => {
                projectile.body.velocity.set(
                dir.x * this.data.speed,
                dir.y * this.data.speed,
                dir.z * this.data.speed
                );
            });

            // auto-dÃ©truire aprÃ¨s 5s pour Ã©viter pollution
            setTimeout(() => {
                if (projectile.parentNode) projectile.parentNode.removeChild(projectile);
            }, 5000);

            scene.appendChild(projectile);
            }
        });

        /* === Modification du toggle-hold pour dÃ©clencher le tir === */
        AFRAME.registerComponent('toggle-hold', {
            schema: {
            position: { type: 'vec3', default: { x: 0, y: -0.02, z: -0.04 } },
            rotation: { type: 'vec3', default: { x: 70, y: 180, z: 0 } }
            },
            init: function () {
            this._held = false;
            this._handEl = null;
            this._grabPoint = null;
            this._savedDynamic = null;

            this._onGrabStart = this._onGrabStart.bind(this);
            this._onGrabEnd = this._onGrabEnd.bind(this);
            this._onGripDown = this._onGripDown.bind(this);
            this._onTriggerDown = this._onTriggerDown.bind(this);

            this.el.addEventListener('grab-start', this._onGrabStart);
            this.el.addEventListener('grab-end', this._onGrabEnd);

            if (!this.el.getAttribute('sound')) {
                this.el.setAttribute('sound', 'src: #gunShot; positional: true; volume: 1');
            }
            },
            _onGrabStart: function (evt) {
            const hand = evt.detail?.hand;
            if (!hand) return;

            if (this.el.hasAttribute('dynamic-body')) {
                this._savedDynamic = this.el.getAttribute('dynamic-body');
                this.el.removeAttribute('dynamic-body');
            }

            const gp = document.createElement('a-entity');
            hand.appendChild(gp);
            const pos = this.data.position;
            gp.object3D.position.set(pos.x, pos.y, pos.z);
            gp.object3D.attach(this.el.object3D);

            const rot = this.data.rotation;
            this.el.object3D.position.set(0,0,0);
            this.el.object3D.rotation.set(
                THREE.MathUtils.degToRad(rot.x),
                THREE.MathUtils.degToRad(rot.y),
                THREE.MathUtils.degToRad(rot.z)
            );

            this._held = true;
            this._handEl = hand;
            this._grabPoint = gp;

            hand.addEventListener('gripdown', this._onGripDown);
            hand.addEventListener('triggerdown', this._onTriggerDown);
            },
            _onGrabEnd: function (evt) {
            const hand = evt.detail?.hand;
            if (this._held && this._handEl === hand) {
                if (this._grabPoint?.object3D) {
                this._grabPoint.object3D.attach(this.el.object3D);
                }
            }
            },
            _onGripDown: function (evt) {
            const hand = evt.target;
            if (!this._held || hand !== this._handEl) return;

            this.el.sceneEl.object3D.attach(this.el.object3D);
            if (this._savedDynamic) this.el.setAttribute('dynamic-body', this._savedDynamic);

            hand.removeEventListener('gripdown', this._onGripDown);
            hand.removeEventListener('triggerdown', this._onTriggerDown);
            if (this._grabPoint?.parentNode) this._grabPoint.parentNode.removeChild(this._grabPoint);

            this._held = false;
            this._handEl = null;
            },
            _onTriggerDown: function (evt) {
            if (!this._held) return;

            // ðŸ”« jouer le son
            this.el.components.sound.playSound();

            // ðŸ”« tirer un projectile
            this.el.emit('shoot');
            }
        });
        </script>
    </head>
    <body>
        <a-scene physics="gravity:-9.81" shadow="type: pcfsoft">
        <a-assets>
            <img id="sky" src="sky1.png">
            <a-asset-item id="gunModel" src="assets/scene.gltf"></a-asset-item>
            <audio id="gunShot" src="assets/shoot.wav"></audio>
        </a-assets>

        <!-- LumiÃ¨res -->
        <a-entity light="type: ambient; intensity: 0.5"></a-entity>
        <a-entity light="type: directional; intensity: 0.8; castShadow: true" position="-2 4 -3"></a-entity>

        <!-- Rig + mains -->
        <a-entity id="rig" position="0 0.58 0">
            <a-entity id="head" camera look-controls></a-entity>
            <a-entity id="leftHand"
                    oculus-touch-controls="hand: left"
                    super-hands
                    sphere-collider="objects: .grabbable"
                    static-body></a-entity>
            <a-entity id="rightHand"
                    oculus-touch-controls="hand: right"
                    super-hands
                    sphere-collider="objects: .grabbable"
                    static-body></a-entity>
        </a-entity>

        <!-- Sol -->
        <a-plane rotation="-90 0 0" width="20" height="20"
                color="#7BC8A4" static-body shadow="receive: true"></a-plane>

        <!-- Pistolet -->
        <a-entity id="gun"
                    class="grabbable"
                    gltf-model="#gunModel"
                    position="0 1.5 -3"
                    scale="1.4 1.4 1.4"
                    shadow
                    dynamic-body="mass: 1; shape: box"
                    toggle-hold="position: 0 -0.02 -0.04; rotation: 70 180 0"
                    gun-shoot="speed: 15; offset: 0 0 -0.5">
        </a-entity>

        <a-sky src="#sky"></a-sky>
        </a-scene>
    </body>
</html>

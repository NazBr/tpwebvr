<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />

        <!-- A-Frame -->
        <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

        <!-- Supprimer grabbable natif -->
        <script>
        if (AFRAME.components['grabbable']) delete AFRAME.components['grabbable'];
        </script>

        <!-- aframe-extras (sphere-collider) -->
        <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.2/dist/aframe-extras.min.js"></script>

        <!-- Physics system -->
        <script src="https://cdn.jsdelivr.net/npm/@c-frame/aframe-physics-system@4.2.3/dist/aframe-physics-system.min.js"></script>

        <!-- super-hands -->
        <script src="https://unpkg.com/super-hands@3.0.5/dist/super-hands.min.js"></script>

        <style>body{margin:0}</style>
    </head>
    <body>
        <a-scene
        physics="gravity: -9.81"
        shadow="type: pcfsoft"
        renderer="antialias: true"
        vr-mode-ui="enabled: true"
        device-orientation-permission-ui="enabled: true">

        <a-assets>
            <img id="sky" src="sky1.png">
            <a-asset-item id="gunModel" src="assets/scene.gltf"></a-asset-item>
        </a-assets>

        <!-- Lumières -->
        <a-entity light="type: ambient; color: #ffffff; intensity: 0.5"></a-entity>
        <a-entity light="type: directional; intensity: 0.8; castShadow: true" position="-2 4 -3"></a-entity>

        <!-- RIG + caméra + mains -->
        <a-entity id="rig" position="0 0.58 0" joystick-movement="speed: 2" snap-turn="angle: 30; cooldown: 300">
            <a-entity id="head" camera look-controls wasd-controls="enabled: false"></a-entity>

            <!-- Main gauche -->
            <a-entity id="leftHand"
            oculus-touch-controls="hand: left"
            super-hands="grabStartButtons: gripdown, squeezestart; grabEndButtons: gripup, squeezeend"
            sphere-collider="objects: .grabbable"
            static-body="shape: sphere; sphereRadius: 0.03">
            </a-entity>

            <!-- Main droite -->
            <a-entity id="rightHand"
            oculus-touch-controls="hand: right"
            super-hands="grabStartButtons: gripdown, squeezestart; grabEndButtons: gripup, squeezeend"
            sphere-collider="objects: .grabbable"
            static-body="shape: sphere; sphereRadius: 0.03">
            </a-entity>
        </a-entity>

        <!-- Sol -->
        <a-plane position="0 0 0" rotation="-90 0 0" width="20" height="20"
            color="#7BC8A4" static-body shadow="receive: true"></a-plane>

        <!-- Table (supporte le pistolet mais pas de collisions avec les mains) -->
        <a-box id="table"
            position="0 0.5 -3"
            scale="2 0.7 2"
            color="#4CC3D9"
            shadow
            static-body="collisionFilterGroup:2; collisionFilterMask:1">
        </a-box>

        <!-- Pistolet -->
        <a-entity id="gun" rotation="0 0 0"
            class="grabbable"
            gltf-model="#gunModel"
            position="0.10047 1.17377 -3.01759"
            scale="1.4 1.4 1.4"
            shadow
            dynamic-body="mass: 1; shape: box"
            toggle-hold="position: 0 -0.02 -0.04; rotation: 70 180 0"
            gun-shoot="speed: 100; offset: 0 0.5 0.05">
            <a-entity id="tracker" position="-0.00293 0.0198 0.28446"></a-entity>
        </a-entity>

        <a-sky src="#sky"></a-sky>
        </a-scene>

        <script>
        // joystick-movement
        AFRAME.registerComponent('joystick-movement', {
        schema: { speed: { type: 'number', default: 2 } },
        init: function () {
            const rig = document.querySelector('#rig');
            const head = document.querySelector('#head');
            const leftHand = document.querySelector('#leftHand');
            const speed = this.data.speed;
            const DEADZONE = 0.1;

            leftHand.addEventListener('thumbstickmoved', function (evt) {
            const dx = evt.detail.x;
            const dy = evt.detail.y;
            if (Math.abs(dx) < DEADZONE && Math.abs(dy) < DEADZONE) return;

            const forward = new THREE.Vector3();
            head.object3D.getWorldDirection(forward);
            forward.y = 0; forward.normalize();

            const right = new THREE.Vector3();
            right.crossVectors(forward, new THREE.Vector3(0, 1, 0)).negate();

            const step = 0.05 * speed;
            const rigPos = rig.object3D.position;
            rigPos.addScaledVector(forward, dy * step);
            rigPos.addScaledVector(right, dx * step);
            });
        }
        });

        // snap-turn
        AFRAME.registerComponent('snap-turn', {
        schema: { angle: { type: 'number', default: 30 }, cooldown: { type: 'number', default: 300 } },
        init: function () {
            const rig = document.querySelector('#rig');
            const rightHand = document.querySelector('#rightHand');
            const angle = this.data.angle;
            const cooldown = this.data.cooldown;
            let lastTurn = 0;

            rightHand.addEventListener('thumbstickmoved', function (evt) {
            const now = Date.now();
            if (now - lastTurn < cooldown) return;
            const x = evt.detail.x;
            if (x > 0.8) {
                rig.object3D.rotation.y -= THREE.MathUtils.degToRad(angle);
                lastTurn = now;
            } else if (x < -0.8) {
                rig.object3D.rotation.y += THREE.MathUtils.degToRad(angle);
                lastTurn = now;
            }
            });
        }
        });

        // toggle-hold : maintient + fixed grab + main invisible
        AFRAME.registerComponent('toggle-hold', {
        schema: {
            position: {type: 'vec3', default: {x:0, y:0, z:0}},
            rotation: {type: 'vec3', default: {x:0, y:0, z:0}}
        },
        init: function () {
            this._held = false;
            this._handEl = null;
            this._savedDynamic = null;

            this._onGrabStart = this._onGrabStart.bind(this);
            this._onGripDown = this._onGripDown.bind(this);

            this.el.addEventListener('grab-start', this._onGrabStart);
        },
        _onGrabStart: function (evt) {
            if (this._held) return;

            const hand = evt.detail?.hand;
            if (!hand) return;

            if (this.el.hasAttribute('dynamic-body')) {
            this._savedDynamic = this.el.getAttribute('dynamic-body');
            this.el.removeAttribute('dynamic-body');
            }

            hand.object3D.attach(this.el.object3D);

            const pos = this.data.position;
            this.el.object3D.position.set(pos.x, pos.y, pos.z);
            const rot = this.data.rotation;
            this.el.object3D.rotation.set(
            THREE.MathUtils.degToRad(rot.x),
            THREE.MathUtils.degToRad(rot.y),
            THREE.MathUtils.degToRad(rot.z)
            );

            hand.setAttribute('visible', false);

            this._held = true;
            this._handEl = hand;

            hand.addEventListener('gripdown', this._onGripDown);
        },
        _onGripDown: function () {
            if (!this._held || !this._handEl) return;

            this._handEl.sceneEl.object3D.attach(this.el.object3D);
            if (this._savedDynamic) {
            this.el.setAttribute('dynamic-body', this._savedDynamic);
            this._savedDynamic = null;
            }

            this._handEl.setAttribute('visible', true);

            this._handEl.removeEventListener('gripdown', this._onGripDown);

            this._held = false;
            this._handEl = null;
        }
        });

        AFRAME.registerComponent('gun-shoot', {
        schema: {
            speed: {type: 'number', default: 200} // vitesse initiale du projectile
        },
        init: function () {
            this._onTriggerDown = this._onTriggerDown.bind(this);

            this.el.addEventListener('grab-start', evt => {
            const hand = evt.detail?.hand;
            if (hand) {
                hand.addEventListener('triggerdown', this._onTriggerDown);
            }
            });

            this.el.addEventListener('grab-end', evt => {
            const hand = evt.detail?.hand;
            if (hand) {
                hand.removeEventListener('triggerdown', this._onTriggerDown);
            }
            });

            this.tracker = this.el.querySelector('#tracker');
        },
        _onTriggerDown: function () {
            if (!this.el.components['toggle-hold']._held) return;
            if (!this.tracker) return;

            const bullet = document.createElement('a-sphere');
            bullet.setAttribute('radius', 0.025);
            bullet.setAttribute('color', 'yellow');
            bullet.setAttribute('shadow', 'cast: true');
            bullet.setAttribute('dynamic-body', 'mass:0.05; shape:sphere; sphereRadius:0.025');

            // Position = sortie du canon
            const worldPos = new THREE.Vector3();
            this.tracker.object3D.getWorldPosition(worldPos);
            bullet.setAttribute('position', `${worldPos.x} ${worldPos.y} ${worldPos.z}`);

            this.el.sceneEl.appendChild(bullet);

            // Calcul direction du tir
            const dir = new THREE.Vector3(0, 0, -1);
            dir.applyQuaternion(this.tracker.object3D.quaternion);
            dir.normalize();

            // On applique la vélocité APRES que le body est chargé
            bullet.addEventListener('body-loaded', () => {
            const velocity = new CANNON.Vec3(
                dir.x * this.data.speed,
                dir.y * this.data.speed,
                dir.z * this.data.speed
            );

            // Ajout de la vitesse du pistolet lui-même (si tu bouges en tirant)
            if (this.el.body) {
                velocity.vadd(this.el.body.velocity, velocity);
            }

            bullet.body.velocity.copy(velocity);
            });

            // Supprimer les balles après 3 secondes pour éviter le lag
            setTimeout(() => {
            if (bullet.parentNode) {
                bullet.parentNode.removeChild(bullet);
            }
            }, 3000);
        }
        });

        </script>
    </body>
</html>

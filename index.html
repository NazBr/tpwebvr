<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>A-Frame — Super Hands + Physics (Meta Touch)</title>

        <!-- A-Frame -->
        <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

        <!-- Physics system (c-frame) -->
        <script src="https://cdn.jsdelivr.net/npm/@c-frame/aframe-physics-system@4.2.3/dist/aframe-physics-system.min.js"></script>

        <!-- IMPORTANT: Supprimer le composant grabbable natif d’A-Frame pour éviter le conflit avec super-hands -->
        <script>
        if (window.AFRAME && AFRAME.components && AFRAME.components['grabbable']) {
            delete AFRAME.components['grabbable'];
            console.warn('Removed built-in AFRAME.components.grabbable to allow super-hands to register.');
        }
        </script>

        <!-- Physics extras -->
        <script src="https://cdn.jsdelivr.net/npm/aframe-physics-extras@0.1.3/dist/aframe-physics-extras.min.js"></script>

        <!-- Super-hands -->
        <script src="https://unpkg.com/super-hands@3.0.5/dist/super-hands.min.js"></script>

        <style>body{margin:0}</style>
    </head>
    <body>
        <a-scene physics="gravity: -9.81" shadow="type: pcfsoft">

        <a-assets>
            <img id="sky" src="sky1.png">
        </a-assets>

        <!-- lumières -->
        <a-entity light="type: ambient; color: #ffffff; intensity: 0.5"></a-entity>
        <a-entity light="type: directional; intensity: 0.8; castShadow: true" position="-2 4 -3"></a-entity>

        <!-- rig & cam -->
        <a-entity id="rig" position="0 0.58 0">
            <a-entity id="head" camera look-controls wasd-controls="enabled: false"></a-entity>

            <!-- mains Meta Touch avec super-hands -->
            <a-entity id="leftHand"
                    meta-touch-controls="hand: left"
                    physics-collider
                    static-body="shape: sphere; sphereRadius: 0.03"
                    super-hands="colliderEvent: collisions;
                                colliderEventProperty: els;
                                colliderEndEvent: collisions;
                                colliderEndEventProperty: clearedEls"
                    collision-filter="group: hands; collidesWith: default; collisionForces: false">
            </a-entity>

            <a-entity id="rightHand"
                    meta-touch-controls="hand: right"
                    physics-collider
                    static-body="shape: sphere; sphereRadius: 0.03"
                    super-hands="colliderEvent: collisions;
                                colliderEventProperty: els;
                                colliderEndEvent: collisions;
                                colliderEndEventProperty: clearedEls"
                    collision-filter="group: hands; collidesWith: default; collisionForces: false">
            </a-entity>
        </a-entity>

        <!-- sol -->
        <a-plane position="0 0 0" rotation="-90 0 0" width="20" height="20" color="#7BC8A4" static-body shadow="receive: true"></a-plane>

        <!-- objet grabbable -->
        <a-box id="grabBox"
                dynamic-body
                grabbable
                draggable
                stretchable
                sleepy
                position="0 1 -3"
                color="#4CC3D9"
                shadow="cast: true">
        </a-box>

        <a-sky src="#sky"></a-sky>
        </a-scene>

        <script>
        // joystick-movement 
        AFRAME.registerComponent('joystick-movement', {
            schema: { speed: { type: 'number', default: 2 } },
            init: function () {
            const rig = document.querySelector('#rig');
            const head = document.querySelector('#head');
            const leftHand = document.querySelector('#leftHand');
            const speed = this.data.speed;

            leftHand.addEventListener('thumbstickmoved', function (evt) {
                const dx = evt.detail.x;
                const dy = evt.detail.y;
                if (Math.abs(dx) > 0.1 || Math.abs(dy) > 0.1) {
                const rigPos = rig.object3D.position;
                const camDir = new THREE.Vector3();
                head.object3D.getWorldDirection(camDir);
                camDir.y = 0; camDir.normalize();
                const forward = camDir;
                const right = new THREE.Vector3();
                right.crossVectors(forward, new THREE.Vector3(0, 1, 0)).negate();
                rigPos.addScaledVector(forward, dy * 0.05 * speed);
                rigPos.addScaledVector(right, dx * 0.05 * speed);
                }
            });
            }
        });

        // snap-turn 
        AFRAME.registerComponent('snap-turn', {
            schema: { angle: { type: 'number', default: 30 }, cooldown: { type: 'number', default: 300 } },
            init: function () {
            const rig = document.querySelector('#rig');
            const rightHand = document.querySelector('#rightHand');
            const angle = this.data.angle;
            const cooldown = this.data.cooldown;
            let lastTurn = 0;

            rightHand.addEventListener('thumbstickmoved', function (evt) {
                const now = Date.now();
                if (now - lastTurn < cooldown) return;
                const x = evt.detail.x;
                if (x > 0.8) { rig.object3D.rotation.y -= THREE.MathUtils.degToRad(angle); lastTurn = now; }
                else if (x < -0.8) { rig.object3D.rotation.y += THREE.MathUtils.degToRad(angle); lastTurn = now; }
            });
            }
        });

        document.querySelector('#rig').setAttribute('joystick-movement', 'speed: 2');
        document.querySelector('#rig').setAttribute('snap-turn', 'angle: 30; cooldown: 300');
        </script>
    </body>
</html>

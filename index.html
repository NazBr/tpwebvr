<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>A-Frame — Grab Objects + Joystick VR</title>

        <!-- A-Frame -->
        <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

        <!-- Supprimer grabbable natif -->
        <script> if (AFRAME.components['grabbable']) delete AFRAME.components['grabbable']; </script>

        <!-- aframe-extras (sphere-collider) -->
        <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.2/dist/aframe-extras.min.js"></script>

        <!-- Physics system -->
        <script src="https://cdn.jsdelivr.net/npm/@c-frame/aframe-physics-system@4.2.3/dist/aframe-physics-system.min.js"></script>

        <!-- super-hands -->
        <script src="https://unpkg.com/super-hands@3.0.5/dist/super-hands.min.js"></script>

        <style>body{margin:0}</style>
    </head>
    <body>
        <a-scene
        physics="gravity: -9.81"
        shadow="type: pcfsoft"
        renderer="antialias: true"
        vr-mode-ui="enabled: true"
        device-orientation-permission-ui="enabled: true">

        <a-assets>
            <img id="sky" src="sky1.png">
            <a-asset-item id="gun" src="assets/scene.gltf"></a-asset-item>
        </a-assets>

        <!-- Lumières -->
        <a-entity light="type: ambient; color: #ffffff; intensity: 0.5"></a-entity>
        <a-entity light="type: directional; intensity: 0.8; castShadow: true" position="-2 4 -3"></a-entity>

        <!-- RIG + caméra + mains -->
        <a-entity id="rig" position="0 0.58 0" joystick-movement="speed: 2" snap-turn="angle: 30; cooldown: 300">
            <a-entity id="head" camera look-controls wasd-controls="enabled: false"></a-entity>

            <!-- Main gauche -->
            <a-entity id="leftHand"
            oculus-touch-controls="hand: left"
            super-hands="grabStartButtons: gripdown, squeezestart; grabEndButtons: gripup, squeezeend"
            sphere-collider="objects: .grabbable"
            static-body="shape: sphere; sphereRadius: 0.03">
            </a-entity>

            <!-- Main droite -->
            <a-entity id="rightHand"
            oculus-touch-controls="hand: right"
            super-hands="grabStartButtons: gripdown, squeezestart; grabEndButtons: gripup, squeezeend"
            sphere-collider="objects: .grabbable"
            static-body="shape: sphere; sphereRadius: 0.03">
            </a-entity>
        </a-entity>

        <!-- Sol -->
        <a-plane position="0 0 0" rotation="-90 0 0" width="20" height="20"
            color="#7BC8A4" static-body shadow="receive: true"></a-plane>

        <a-box id="table"
                position="0 1 -3"
                color="#4CC3D9"
                shadow="cast: true"
                dynamic-body="mass: 1; shape: box">
        </a-box>

        <a-entity class="grabbable"
                gltf-model="#gun"
                position="1 1 -2"
                scale="0.5 0.5 0.5"
                rotation="0 45 0"
                dynamic-body="mass: 1; shape: box"
                grabbable="usePhysics: only; startButtons: gripdown, squeezestart; endButtons: gripup, squeezeend"
                shadow="cast: true; receive: true">
        </a-entity>

        <a-sky src="#sky"></a-sky>
        </a-scene>

        <script>
        // joystick-movement 
        AFRAME.registerComponent('joystick-movement', {
            schema: { speed: { type: 'number', default: 2 } },
            init: function () {
            const rig = document.querySelector('#rig');
            const head = document.querySelector('#head');
            const leftHand = document.querySelector('#leftHand');
            const speed = this.data.speed;
            const DEADZONE = 0.1;

            leftHand.addEventListener('thumbstickmoved', function (evt) {
                const dx = evt.detail.x;
                const dy = evt.detail.y;
                if (Math.abs(dx) < DEADZONE && Math.abs(dy) < DEADZONE) return;

                const forward = new THREE.Vector3();
                head.object3D.getWorldDirection(forward);
                forward.y = 0; forward.normalize();

                const right = new THREE.Vector3();
                right.crossVectors(forward, new THREE.Vector3(0, 1, 0)).negate();

                const step = 0.05 * speed;
                const rigPos = rig.object3D.position;
                rigPos.addScaledVector(forward, dy * step);
                rigPos.addScaledVector(right, dx * step);
            });
            }
        });

        // snap-turn 
        AFRAME.registerComponent('snap-turn', {
            schema: { angle: { type: 'number', default: 30 }, cooldown: { type: 'number', default: 300 } },
            init: function () {
            const rig = document.querySelector('#rig');
            const rightHand = document.querySelector('#rightHand');
            const angle = this.data.angle;
            const cooldown = this.data.cooldown;
            let lastTurn = 0;

            rightHand.addEventListener('thumbstickmoved', function (evt) {
                const now = Date.now();
                if (now - lastTurn < cooldown) return;
                const x = evt.detail.x;
                if (x > 0.8) {
                rig.object3D.rotation.y -= THREE.MathUtils.degToRad(angle);
                lastTurn = now;
                } else if (x < -0.8) {
                rig.object3D.rotation.y += THREE.MathUtils.degToRad(angle);
                lastTurn = now;
                }
            });
            }
        });
        </script>
    </body>
</html>
